<!DOCTYPE html>
<html>
<head>
    <title>OppEnergy WebSocket Test</title>
    <style>
        /* Previous styles remain the same */
        #log {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
            overflow-y: scroll;
            font-family: monospace;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        .debug { color: purple; }
        input {
            width: 200px;
            padding: 5px;
            margin-right: 10px;
        }
        .control-panel {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
        }
        #debugInfo {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>OppEnergy WebSocket Test Page</h1>
    
    <div class="control-panel">
        <h3>Connection</h3>
        <input type="text" id="connInstanceId" placeholder="Instance ID for Connection" value="test123">
        <button onclick="connect()" id="connectBtn">Connect</button>
        <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
        <button onclick="testConnection()" id="testConnBtn">Test Server Connection</button>
        <span id="status">Not Connected</span>
        <div id="debugInfo">
            <strong>Debug Info:</strong><br>
            Protocol: <span id="protocolInfo"></span><br>
            Host: <span id="hostInfo"></span><br>
            WebSocket URL: <span id="wsUrlInfo"></span><br>
            WebSocket State: <span id="wsState"></span><br>
            Instance ID: <span id="siteInfo"></span>
        </div>
    </div>

    <!-- Rest of the control panels remain the same -->
    <div class="control-panel">
        <h3>Site Registration</h3>
        <input type="text" id="userName" placeholder="User Name">
        <input type="text" id="SiteId" placeholder="Site ID">
        <input type="text" id="siteId" placeholder="Instance ID">
        <button onclick="registerSite()" id="registerBtn" disabled>Register Site</button>
    </div>

    <div class="control-panel">
        <h3>Site Login</h3>
        <input type="text" id="loginSiteId" placeholder="Site ID">
        <button onclick="login()" id="loginBtn" disabled>Login</button>
    </div>

    <div class="control-panel">
        <h3>Site List</h3>
        <button onclick="getRegisteredSites()" id="listSitesBtn" disabled>Get Registered Sites</button>
    </div>

    <div id="log"></div>

    <script>
        let ws = null;
        let connectionAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 3;
        const messageQueue = [];
        let processingQueue = false;

        async function sendMessage(message) {
            messageQueue.push(message);
            if (!processingQueue) {
                await processMessageQueue();
            }
        }

        async function processMessageQueue() {
            if (messageQueue.length === 0 || processingQueue) return;
            
            processingQueue = true;
            while (messageQueue.length > 0) {
                const message = messageQueue[0];
                try {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify(message));
                        messageQueue.shift(); // Remove sent message
                        addLog(`Message sent: ${JSON.stringify(message)}`, 'debug');
                    } else {
                        throw new Error('WebSocket not connected');
                    }
                } catch (error) {
                    addLog(`Failed to send message: ${error.message}`, 'error');
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 100)); // Rate limiting
            }
            processingQueue = false;
        }

        let reconnectTimeout = 1000; // Start with 1 second
        const MAX_RECONNECT_TIMEOUT = 30000; // Max 30 seconds
        
        function handleReconnection() {
            if (connectionAttempts < MAX_RECONNECT_ATTEMPTS) {
                addLog(`Reconnecting in ${reconnectTimeout/1000} seconds...`, 'info');
                setTimeout(() => {
                    reconnectTimeout = Math.min(reconnectTimeout * 2, MAX_RECONNECT_TIMEOUT);
                    connect();
                }, reconnectTimeout);
            } else {
                addLog('Max reconnection attempts reached', 'error');
                reconnectTimeout = 1000; // Reset for next time
            }
        }

        // Update the WebSocket URL function to include site_id
        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const siteId = document.getElementById('connInstanceId').value.trim() || 'test123';
            return `${protocol}//${window.location.host}/ws/opp_energy/${siteId}/`;
        }

        // Add a server connection test function
        async function testConnection() {
            const httpProtocol = window.location.protocol;
            const host = window.location.host;
            const testUrl = `${httpProtocol}//${host}/`;
            
            addLog('Testing server connection...', 'info');
            try {
                const response = await fetch(testUrl);
                if (response.ok) {
                    addLog(`Server is accessible at ${testUrl}`, 'success');
                } else {
                    addLog(`Server returned status: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`Server connection test failed: ${error.message}`, 'error');
            }
        }

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateDebugInfo() {
            const siteId = document.getElementById('connInstanceId').value.trim() || 'test123';
            document.getElementById('protocolInfo').textContent = window.location.protocol;
            document.getElementById('hostInfo').textContent = window.location.host;
            document.getElementById('wsUrlInfo').textContent = getWebSocketUrl();
            document.getElementById('wsState').textContent = ws ? ws.readyState : 'No WebSocket site';
            document.getElementById('siteInfo').textContent = siteId;
        }

        function updateButtons(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            registerBtn.disabled = !connected;
            loginBtn.disabled = !connected;
            listSitesBtn.disabled = !connected;
            document.getElementById('connInstanceId').disabled = connected;
            status.textContent = connected ? 'Connected' : 'Not Connected';
            status.style.color = connected ? 'green' : 'red';
        }

        function connect() {
            const siteId = document.getElementById('connInstanceId').value.trim();
            if (!siteId) {
                addLog('Please enter an Instance ID for connection', 'error');
                return;
            }

            if (connectionAttempts >= MAX_RECONNECT_ATTEMPTS) {
                addLog(`Maximum reconnection attempts (${MAX_RECONNECT_ATTEMPTS}) reached. Please check your connection and try again later.`, 'error');
                connectionAttempts = 0;
                return;
            }

            connectionAttempts++;
            addLog(`Connection attempt ${connectionAttempts} of ${MAX_RECONNECT_ATTEMPTS}`, 'debug');
            
            const wsUrl = getWebSocketUrl();
            addLog('Attempting to connect...', 'info');
            addLog(`WebSocket URL: ${wsUrl}`, 'debug');
            
            try {
                try {
                    ws = new WebSocket(wsUrl);
                } catch (error) {
                    addLog(`WebSocket creation failed: ${error.message}`, 'error');
                    return;
                }
                
                ws.onopen = () => {
                    addLog('Connection established!', 'success');
                    addLog(`WebSocket ready state: ${ws.readyState}`, 'debug');
                    connectionAttempts = 0;
                    updateStatus(true, `Connected to ${ws.url}`);
                    updateButtons(true);
                    updateDebugInfo();
                    
                    // Send initial handshake message
                    try {
                        ws.send(JSON.stringify({
                            type: 'connection_init',
                            site_id: document.getElementById('connInstanceId').value.trim()
                        }));
                    } catch (error) {
                        addLog(`Error sending initial handshake: ${error.message}`, 'error');
                    }
                    // Log the current state of UI elements
                    addLog(`Connect button disabled: ${connectBtn.disabled}`, 'debug');
                    addLog(`Disconnect button disabled: ${disconnectBtn.disabled}`, 'debug');
                    addLog(`Status element text: ${document.getElementById('status').textContent}`, 'debug');
                };

                function startHeartbeat() {
                    const heartbeatInterval = setInterval(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            try {
                                ws.send(JSON.stringify({ type: 'heartbeat' }));
                                addLog('Heartbeat sent', 'debug');
                            } catch (error) {
                                addLog(`Heartbeat error: ${error.message}`, 'error');
                                clearInterval(heartbeatInterval);
                            }
                        } else {
                            clearInterval(heartbeatInterval);
                        }
                    }, 30000); // every 30 seconds
                    
                    return heartbeatInterval;
                }

                ws.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        addLog(`Raw message received: ${e.data}`, 'debug');
                        
                        let message = '';
                        switch(data.type) {
                            case 'registration_success':
                                message = `Registration successful: ${data.message}`;
                                break;
                            case 'login_success':
                                message = `Login successful - User: ${data.user_name}, Instance: ${data.site_id}`;
                                break;
                            case 'Site_list':
                                message = `Registered sites: ${data.sites.join(', ')}`;
                                break;
                            case 'error':
                                message = `Error: ${data.message}`;
                                break;
                            default:
                                message = JSON.stringify(data);
                        }
                        
                        addLog(message, data.type === 'error' ? 'error' : 'success');
                    } catch (error) {
                        addLog(`Error parsing message: ${error.message}`, 'error');
                        addLog(`Raw message: ${e.data}`, 'debug');
                    }
                };
                
                ws.onerror = (e) => {
                    addLog('WebSocket error occurred', 'error');
                    addLog(`WebSocket readyState: ${ws.readyState}`, 'debug');
                    addLog(`Attempted URL: ${ws.url}`, 'debug');
                    
                    // Check if there's an error event with more details
                    if (e instanceof ErrorEvent) {
                        addLog(`Error message: ${e.message}`, 'error');
                    }
                    
                    console.error('WebSocket error:', e);
                    updateButtons(false);
                    updateDebugInfo();
                };
                
                ws.onclose = (e) => {
                    const reasons = {
                        1000: "Normal closure",
                        1001: "Going away",
                        1002: "Protocol error",
                        1003: "Unsupported data",
                        1005: "No status received",
                        1006: "Abnormal closure",
                        1007: "Invalid frame payload data",
                        1008: "Policy violation",
                        1009: "Message too big",
                        1010: "Missing extension",
                        1011: "Internal error",
                        1012: "Service restart",
                        1013: "Try again later",
                        1015: "TLS handshake"
                    };
                    
                    const reason = reasons[e.code] || "Unknown reason";
                    addLog(`Connection closed. Code: ${e.code} (${reason}), Reason: ${e.reason || 'No reason provided'}`, 'error');
                    addLog(`Was clean closure: ${e.wasClean}`, 'debug');
                    
                    updateStatus(false, `Closed: ${reason}`);
                    updateButtons(false);
                    updateDebugInfo();
                    ws = null;
                };
                
            } catch (error) {
                addLog(`Error creating WebSocket: ${error.message}`, 'error');
                updateButtons(false);
                updateDebugInfo();
            }
        }

        function disconnect() {
            if (ws) {
                ws.close(1000, "User initiated disconnect");
                addLog('Disconnecting...', 'info');
                cleanupConnection();
            }
        }
        
        function cleanupConnection() {
            ws = null;
            connectionAttempts = 0;
            reconnectTimeout = 1000;
            messageQueue.length = 0; // Clear message queue
            updateButtons(false);
            updateDebugInfo();
        }

        function registerSite() {
            if (!ws) return;
            
            const userName = document.getElementById('userName').value.trim();
            const siteId = document.getElementById('siteId').value.trim();
            const siteId = document.getElementById('siteId').value.trim();
            
            if (!userName || !siteId || !siteId) {
                addLog('Please fill in all registration fields', 'error');
                return;
            }
            
            const message = {
                type: 'register_site',
                user_name: userName,
                site_id: siteId,
                site_id: siteId
            };
            
            ws.send(JSON.stringify(message));
            addLog(`Registering site: ${siteId}`, 'info');
        }

        function login() {
            if (!ws) return;
            
            const siteId = document.getElementById('loginSiteId').value.trim();
            
            if (!siteId) {
                addLog('Please enter a site ID', 'error');
                return;
            }
            
            const message = {
                type: 'login',
                site_id: siteId
            };
            
            ws.send(JSON.stringify(message));
            addLog(`Attempting login for site: ${siteId}`, 'info');
        }

        function getRegisteredSites() {
            if (!ws) return;
            
            const message = {
                type: 'get_registered_sites'
            };
            
            ws.send(JSON.stringify(message));
            addLog('Requesting registered sites list', 'info');
        }

        function updateStatus(connected, message = '') {
            const statusElement = document.getElementById('status');
            if (!statusElement) {
                console.error('Status element not found');
                return;
            }
            
            statusElement.textContent = connected ? 'Connected' : 'Not Connected';
            statusElement.style.color = connected ? 'green' : 'red';
            
            if (message) {
                statusElement.textContent += ` - ${message}`;
            }
            
            // Debug log the status update
            addLog(`Status updated: ${statusElement.textContent}`, 'debug');
        }

        // Initial debug info update
        updateDebugInfo();
    </script>
</body>
</html>